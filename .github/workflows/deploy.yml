name: π€ M-CENTER λ³„-AIμƒλ‹΄μ‚¬ μλ™ λ°°ν¬

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  Deploy-Production:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: π“¥ Checkout
      uses: actions/checkout@v4
      
    - name: π”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: π“¦ Install dependencies
      run: npm ci
      
    - name: π” Environment Variables Check
      run: |
        echo "π” ν™κ²½λ³€μ κ²€μ¦ μ¤‘..."
        echo "β… GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY != '' }}"
        echo "β… EMAILJS_SERVICE_ID: ${{ secrets.NEXT_PUBLIC_EMAILJS_SERVICE_ID != '' }}"
        echo "β… GOOGLE_SHEETS_ID: ${{ secrets.NEXT_PUBLIC_GOOGLE_SHEETS_ID != '' }}"
        echo "β… NODE_ENV: production"
        
    - name: π—οΈ Build Application
      run: npm run build
      env:
        # π¤– AI κ΄€λ ¨ ν™κ²½λ³€μ (μ„λ²„ μ‚¬μ΄λ“ μ „μ©)
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        
        # π“§ EmailJS κ΄€λ ¨ ν™κ²½λ³€μ (ν΄λΌμ΄μ–ΈνΈ μ‚¬μ΄λ“ ν—μ©)
        NEXT_PUBLIC_EMAILJS_SERVICE_ID: ${{ secrets.NEXT_PUBLIC_EMAILJS_SERVICE_ID }}
        NEXT_PUBLIC_EMAILJS_PUBLIC_KEY: ${{ secrets.NEXT_PUBLIC_EMAILJS_PUBLIC_KEY }}
        NEXT_PUBLIC_EMAILJS_TEMPLATE_DIAGNOSIS: ${{ secrets.NEXT_PUBLIC_EMAILJS_TEMPLATE_DIAGNOSIS }}
        NEXT_PUBLIC_EMAILJS_TEMPLATE_CONSULTATION: ${{ secrets.NEXT_PUBLIC_EMAILJS_TEMPLATE_CONSULTATION }}
        NEXT_PUBLIC_EMAILJS_TEMPLATE_ADMIN: ${{ secrets.NEXT_PUBLIC_EMAILJS_TEMPLATE_ADMIN }}
        
        # π“ Google Sheets κ΄€λ ¨ ν™κ²½λ³€μ (ν΄λΌμ΄μ–ΈνΈ μ‚¬μ΄λ“ ν—μ©)
        NEXT_PUBLIC_GOOGLE_SHEETS_ID: ${{ secrets.NEXT_PUBLIC_GOOGLE_SHEETS_ID }}
        NEXT_PUBLIC_GOOGLE_SCRIPT_URL: ${{ secrets.NEXT_PUBLIC_GOOGLE_SCRIPT_URL }}
        NEXT_PUBLIC_GOOGLE_SCRIPT_ID: ${{ secrets.NEXT_PUBLIC_GOOGLE_SCRIPT_ID }}
        NEXT_PUBLIC_GOOGLE_SCRIPT_DEPLOYMENT_ID: ${{ secrets.NEXT_PUBLIC_GOOGLE_SCRIPT_DEPLOYMENT_ID }}
        NEXT_PUBLIC_GOOGLE_SHEETS_URL: ${{ secrets.NEXT_PUBLIC_GOOGLE_SHEETS_URL }}
        
        # π μ‚¬μ΄νΈ μ„¤μ •
        NEXT_PUBLIC_BASE_URL: ${{ secrets.NEXT_PUBLIC_BASE_URL }}
        ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
        
        # π¤– AI μƒλ‹΄μ‚¬ μ„¤μ •
        NEXT_PUBLIC_AI_ASSISTANT_NAME: ${{ secrets.NEXT_PUBLIC_AI_ASSISTANT_NAME }}
        NEXT_PUBLIC_AI_ASSISTANT_DESCRIPTION: ${{ secrets.NEXT_PUBLIC_AI_ASSISTANT_DESCRIPTION }}
        
        # π”§ μ‹μ¤ν… μ„¤μ •
        NODE_ENV: production
        NOTIFICATION_ENABLED: true
        AUTO_REPLY_ENABLED: true
        
    - name: π§ Build Verification
      run: |
        echo "π§ λΉλ“ κ²€μ¦ μ¤‘..."
        if [ -d ".next" ]; then
          echo "β… Next.js λΉλ“ μ„±κ³µ"
          ls -la .next/
        else
          echo "β Next.js λΉλ“ μ‹¤ν¨"
          exit 1
        fi
        
    # π§ Vercel λ°°ν¬ μΌμ‹ λΉ„ν™μ„±ν™” (Secrets μ„¤μ • ν›„ ν™μ„±ν™”)
    # - name: π€ Deploy to Vercel (Production)
    #   uses: amondnet/vercel-action@v25
    #   with:
    #     vercel-token: ${{ secrets.VERCEL_TOKEN }}
    #     github-token: ${{ secrets.GITHUB_TOKEN }}
    #     vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
    #     vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
    #     working-directory: ./
        
    # - name: π” Post-Deploy Health Check
    #   run: |
    #     echo "π” λ°°ν¬ ν›„ μƒνƒ ν™•μΈ μ¤‘..."
    #     sleep 30
    #     curl -f "${{ secrets.NEXT_PUBLIC_BASE_URL }}/api/test-env" || echo "β οΈ Health check failed"
        
    - name: π“Ά Build Success Notification
      if: success()
      run: |
        echo "π‰ M-CENTER λ³„-AIμƒλ‹΄μ‚¬ λΉλ“ μ„±κ³µ!"
        echo "π¤– Gemini AI: ν™κ²½λ³€μ μ„¤μ • μ™„λ£"
        echo "π“§ EmailJS: ν™κ²½λ³€μ μ„¤μ • μ™„λ£"
        echo "π“ Google Sheets: ν™κ²½λ³€μ μ„¤μ • μ™„λ£"
        echo "π§ Vercel λ°°ν¬: μΌμ‹ λΉ„ν™μ„±ν™” (μ„¤μ • ν›„ ν™μ„±ν™” μμ •)"
        
  Deploy-Preview:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: π“¥ Checkout
      uses: actions/checkout@v4
      
    - name: π”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: π“¦ Install dependencies
      run: npm ci
      
    - name: π—οΈ Build Application (Preview)
      run: npm run build
      env:
        # π¤– AI κ΄€λ ¨ ν™κ²½λ³€μ
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        
        # π“§ EmailJS κ΄€λ ¨ ν™κ²½λ³€μ
        NEXT_PUBLIC_EMAILJS_SERVICE_ID: ${{ secrets.NEXT_PUBLIC_EMAILJS_SERVICE_ID }}
        NEXT_PUBLIC_EMAILJS_PUBLIC_KEY: ${{ secrets.NEXT_PUBLIC_EMAILJS_PUBLIC_KEY }}
        NEXT_PUBLIC_EMAILJS_TEMPLATE_DIAGNOSIS: ${{ secrets.NEXT_PUBLIC_EMAILJS_TEMPLATE_DIAGNOSIS }}
        NEXT_PUBLIC_EMAILJS_TEMPLATE_CONSULTATION: ${{ secrets.NEXT_PUBLIC_EMAILJS_TEMPLATE_CONSULTATION }}
        NEXT_PUBLIC_EMAILJS_TEMPLATE_ADMIN: ${{ secrets.NEXT_PUBLIC_EMAILJS_TEMPLATE_ADMIN }}
        
        # π“ Google Sheets κ΄€λ ¨ ν™κ²½λ³€μ
        NEXT_PUBLIC_GOOGLE_SHEETS_ID: ${{ secrets.NEXT_PUBLIC_GOOGLE_SHEETS_ID }}
        NEXT_PUBLIC_GOOGLE_SCRIPT_URL: ${{ secrets.NEXT_PUBLIC_GOOGLE_SCRIPT_URL }}
        NEXT_PUBLIC_GOOGLE_SCRIPT_ID: ${{ secrets.NEXT_PUBLIC_GOOGLE_SCRIPT_ID }}
        NEXT_PUBLIC_GOOGLE_SCRIPT_DEPLOYMENT_ID: ${{ secrets.NEXT_PUBLIC_GOOGLE_SCRIPT_DEPLOYMENT_ID }}
        NEXT_PUBLIC_GOOGLE_SHEETS_URL: ${{ secrets.NEXT_PUBLIC_GOOGLE_SHEETS_URL }}
        
        # π μ‚¬μ΄νΈ μ„¤μ •
        NEXT_PUBLIC_BASE_URL: ${{ secrets.NEXT_PUBLIC_BASE_URL }}
        ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
        
        # π¤– AI μƒλ‹΄μ‚¬ μ„¤μ •
        NEXT_PUBLIC_AI_ASSISTANT_NAME: ${{ secrets.NEXT_PUBLIC_AI_ASSISTANT_NAME }}
        NEXT_PUBLIC_AI_ASSISTANT_DESCRIPTION: ${{ secrets.NEXT_PUBLIC_AI_ASSISTANT_DESCRIPTION }}
        
        # π”§ μ‹μ¤ν… μ„¤μ •
        NODE_ENV: production
        NOTIFICATION_ENABLED: true
        AUTO_REPLY_ENABLED: true 