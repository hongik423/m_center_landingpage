name: ðŸ”’ ë³´ì•ˆ ê²€ì‚¬ ë° ë°°í¬

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]
  schedule:
    # ë§¤ì¼ ìžì •ì— ë³´ì•ˆ ê²€ì‚¬ ì‹¤í–‰
    - cron: '0 0 * * *'

env:
  NODE_VERSION: '20'

jobs:
  security-audit:
    name: ðŸ” ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: âš™ï¸ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ðŸ” NPM ë³´ì•ˆ ê°ì‚¬
        run: npm audit --audit-level=moderate

      - name: ðŸ”’ ì·¨ì•½í•œ íŒ¨í‚¤ì§€ ìžë™ ìˆ˜ì •
        run: npm audit fix

      - name: ðŸ“Š ë³´ì•ˆ ë¦¬í¬íŠ¸ ìƒì„±
        run: |
          npm audit --json > security-report.json || true
          npm audit --parseable > security-report.txt || true

      - name: ðŸ“¤ ë³´ì•ˆ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v3
        with:
          name: security-reports
          path: |
            security-report.json
            security-report.txt

  secret-scan:
    name: ðŸ•µï¸ ë¹„ë°€í‚¤ ìŠ¤ìº”
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” TruffleHog ë¹„ë°€í‚¤ ìŠ¤ìº”
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

  code-quality:
    name: ðŸ“ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: âš™ï¸ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ðŸ” ë¦°íŠ¸ ê²€ì‚¬
        run: npm run lint

      - name: ðŸ—ï¸ íƒ€ìž… ê²€ì‚¬
        run: npm run type-check

      - name: ðŸ—ï¸ ë¹Œë“œ í…ŒìŠ¤íŠ¸
        run: npm run build

  env-validation:
    name: ðŸ”§ í™˜ê²½ë³€ìˆ˜ ê²€ì¦
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ðŸ” .env.local íŒŒì¼ ëˆ„ì¶œ ê²€ì‚¬
        run: |
          if [ -f ".env.local" ]; then
            echo "âŒ .env.local íŒŒì¼ì´ ì»¤ë°‹ë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo "ì´ íŒŒì¼ì€ ë¯¼ê°í•œ ì •ë³´ë¥¼ í¬í•¨í•˜ê³  ìžˆì–´ GitHubì— ì—…ë¡œë“œë˜ë©´ ì•ˆ ë©ë‹ˆë‹¤."
            exit 1
          else
            echo "âœ… .env.local íŒŒì¼ì´ ì˜¬ë°”ë¥´ê²Œ ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤."
          fi

      - name: ðŸ” API í‚¤ íŒ¨í„´ ê²€ì‚¬
        run: |
          echo "ðŸ” API í‚¤ íŒ¨í„´ ê²€ì‚¬ ì¤‘..."
          
          # OpenAI API í‚¤ ê²€ì‚¬
          if grep -r "sk-proj-" --exclude-dir=node_modules --exclude-dir=.git --exclude="*.md" .; then
            echo "âŒ OpenAI API í‚¤ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤!"
            exit 1
          fi
          
          # EmailJS í‚¤ ê²€ì‚¬
          if grep -r "service_[a-zA-Z0-9]" --exclude-dir=node_modules --exclude-dir=.git --exclude="*.md" .; then
            echo "âš ï¸ EmailJS ì„œë¹„ìŠ¤ IDê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. (Public Keyì´ë¯€ë¡œ í—ˆìš©)"
          fi
          
          # Google ê´€ë ¨ ë¯¼ê° ì •ë³´ ê²€ì‚¬
          if grep -r "AIza[0-9A-Za-z-_]{35}" --exclude-dir=node_modules --exclude-dir=.git --exclude="*.md" .; then
            echo "âŒ Google API í‚¤ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤!"
            exit 1
          fi
          
          echo "âœ… ë¯¼ê°í•œ API í‚¤ê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."

  dependency-review:
    name: ðŸ“¦ ì˜ì¡´ì„± ë¦¬ë·°
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ðŸ” ì˜ì¡´ì„± ë¦¬ë·°
        uses: actions/dependency-review-action@v3
        with:
          fail-on-severity: moderate

  security-scorecard:
    name: ðŸ“Š ë³´ì•ˆ ìŠ¤ì½”ì–´ì¹´ë“œ
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      id-token: write
    if: github.event_name != 'pull_request'
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: ðŸ“Š OSSF Scorecard ì‹¤í–‰
        uses: ossf/scorecard-action@v2.3.1
        with:
          results_file: results.sarif
          results_format: sarif
          publish_results: true

      - name: ðŸ“¤ SARIF ê²°ê³¼ ì—…ë¡œë“œ
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif

  build-and-test:
    name: ðŸ—ï¸ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20]
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: âš™ï¸ Node.js ${{ matrix.node-version }} ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ðŸ—ï¸ ë¹Œë“œ
        run: npm run build

      - name: ðŸ§ª í…ŒìŠ¤íŠ¸ (ìžˆëŠ” ê²½ìš°)
        run: |
          if [ -f "package.json" ] && npm run | grep -q "test"; then
            npm test
          else
            echo "í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤."
          fi

  notify-security-issues:
    name: ðŸ“¢ ë³´ì•ˆ ì´ìŠˆ ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [security-audit, secret-scan, env-validation]
    if: failure()
    steps:
      - name: ðŸ“§ ë³´ì•ˆ ì´ìŠˆ ì•Œë¦¼
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: |
            ðŸš¨ M-CENTER í”„ë¡œì íŠ¸ì—ì„œ ë³´ì•ˆ ì´ìŠˆê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤!
            
            - Repository: ${{ github.repository }}
            - Branch: ${{ github.ref }}
            - Commit: ${{ github.sha }}
            - ìž‘ì—…ìž: ${{ github.actor }}
            
            ì¦‰ì‹œ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: env.SLACK_WEBHOOK_URL != ''

  production-deploy:
    name: ðŸš€ í”„ë¡œë•ì…˜ ë°°í¬
    runs-on: ubuntu-latest
    needs: [security-audit, code-quality, env-validation, build-and-test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: âš™ï¸ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ðŸ—ï¸ í”„ë¡œë•ì…˜ ë¹Œë“œ
        run: npm run build
        env:
          NODE_ENV: production

      - name: ðŸš€ Vercel ë°°í¬
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}
          vercel-args: '--prod'

  security-summary:
    name: ðŸ“‹ ë³´ì•ˆ ê²€ì‚¬ ìš”ì•½
    runs-on: ubuntu-latest
    needs: [security-audit, secret-scan, code-quality, env-validation]
    if: always()
    steps:
      - name: ðŸ“Š ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼ ìš”ì•½
        run: |
          echo "# ðŸ”’ M-CENTER ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ê²€ì‚¬ í•­ëª©ë³„ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ê²€ì‚¬ í•­ëª© | ìƒíƒœ | ì„¤ëª… |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬ | ${{ needs.security-audit.result == 'success' && 'âœ… í†µê³¼' || 'âŒ ì‹¤íŒ¨' }} | NPM íŒ¨í‚¤ì§€ ë³´ì•ˆ ê²€ì‚¬ |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ•µï¸ ë¹„ë°€í‚¤ ìŠ¤ìº” | ${{ needs.secret-scan.result == 'success' && 'âœ… í†µê³¼' || 'âŒ ì‹¤íŒ¨' }} | Git ížˆìŠ¤í† ë¦¬ ë¹„ë°€í‚¤ ê²€ì‚¬ |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ | ${{ needs.code-quality.result == 'success' && 'âœ… í†µê³¼' || 'âŒ ì‹¤íŒ¨' }} | ESLint, TypeScript ê²€ì‚¬ |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”§ í™˜ê²½ë³€ìˆ˜ ê²€ì¦ | ${{ needs.env-validation.result == 'success' && 'âœ… í†µê³¼' || 'âŒ ì‹¤íŒ¨' }} | .env íŒŒì¼ ë° API í‚¤ ê²€ì‚¬ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“ž ë¬¸ì˜" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ë³´ì•ˆ ì´ìŠˆê°€ ë°œê²¬ëœ ê²½ìš° ì¦‰ì‹œ ì—°ë½ì£¼ì„¸ìš”:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“§ ì´ë©”ì¼: hongik423@gmail.com" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ž ì „í™”: 010-9251-9743" >> $GITHUB_STEP_SUMMARY 