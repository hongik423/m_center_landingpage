name: ğŸ”’ Enhanced Security Check

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œì— ì •ê¸° ë³´ì•ˆ ê²€ì‚¬
    - cron: '0 9 * * 1'

permissions:
  contents: read
  security-events: write

jobs:
  # ë¯¼ê°í•œ ì •ë³´ íƒì§€
  secret-detection:
    name: ğŸ” Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: API í‚¤ í•˜ë“œì½”ë”© ê²€ì‚¬
        run: |
          echo "ğŸ” API í‚¤ í•˜ë“œì½”ë”© ê²€ì‚¬ ì‹œì‘..."
          
          # OpenAI API í‚¤ ê²€ì‚¬
          if grep -r "sk-proj-" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" src/; then
            echo "âŒ OpenAI API í‚¤ê°€ í•˜ë“œì½”ë”©ë˜ì–´ ìˆìŠµë‹ˆë‹¤!"
            exit 1
          fi
          
          # Google Apps Script ID ê²€ì‚¬ (ì‹¤ì œ ID íŒ¨í„´)
          if grep -r "AKfycby[a-zA-Z0-9_-]\{50,\}" --include="*.ts" --include="*.tsx" src/; then
            echo "âŒ Google Apps Script IDê°€ í•˜ë“œì½”ë”©ë˜ì–´ ìˆìŠµë‹ˆë‹¤!"
            exit 1
          fi
          
          # ë¹„ë°€ë²ˆí˜¸ í•˜ë“œì½”ë”© ê²€ì‚¬
          if grep -r "password\s*=\s*['\"][^'\"]*['\"]" --include="*.ts" --include="*.tsx" src/; then
            echo "âŒ ë¹„ë°€ë²ˆí˜¸ê°€ í•˜ë“œì½”ë”©ë˜ì–´ ìˆìŠµë‹ˆë‹¤!"
            exit 1
          fi
          
          # ê¸°íƒ€ ë¯¼ê°í•œ ì •ë³´ ê²€ì‚¬
          if grep -r "secret\s*=\s*['\"][^'\"]*['\"]" --include="*.ts" --include="*.tsx" src/; then
            echo "âŒ Secretì´ í•˜ë“œì½”ë”©ë˜ì–´ ìˆìŠµë‹ˆë‹¤!"
            exit 1
          fi
          
          echo "âœ… API í‚¤ í•˜ë“œì½”ë”© ê²€ì‚¬ í†µê³¼"

      - name: í™˜ê²½ë³€ìˆ˜ íŒŒì¼ Git í¬í•¨ ê²€ì‚¬
        run: |
          echo "ğŸ” í™˜ê²½ë³€ìˆ˜ íŒŒì¼ Git í¬í•¨ ê²€ì‚¬..."
          
          if find . -name ".env*" -not -name ".env.example*" -not -path "./node_modules/*" | grep -v ".env.example"; then
            echo "âŒ í™˜ê²½ë³€ìˆ˜ íŒŒì¼ì´ Gitì— í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤!"
            echo "ë°œê²¬ëœ íŒŒì¼ë“¤:"
            find . -name ".env*" -not -name ".env.example*" -not -path "./node_modules/*"
            exit 1
          fi
          
          echo "âœ… í™˜ê²½ë³€ìˆ˜ íŒŒì¼ Git í¬í•¨ ê²€ì‚¬ í†µê³¼"

      - name: ë¯¼ê°í•œ íŒŒì¼ í™•ì¥ì ê²€ì‚¬
        run: |
          echo "ğŸ” ë¯¼ê°í•œ íŒŒì¼ í™•ì¥ì ê²€ì‚¬..."
          
          # ê°œì¸í‚¤, ì¸ì¦ì„œ íŒŒì¼ ê²€ì‚¬
          if find . -name "*.pem" -o -name "*.key" -o -name "*.p12" -o -name "*.pfx" -not -path "./node_modules/*"; then
            echo "âŒ ë¯¼ê°í•œ ì¸ì¦ì„œ/í‚¤ íŒŒì¼ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤!"
            exit 1
          fi
          
          # ë°±ì—… íŒŒì¼ ê²€ì‚¬
          if find . -name "*.backup" -o -name "*.bak" -not -path "./node_modules/*"; then
            echo "âŒ ë°±ì—… íŒŒì¼ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤!"
            exit 1
          fi
          
          echo "âœ… ë¯¼ê°í•œ íŒŒì¼ í™•ì¥ì ê²€ì‚¬ í†µê³¼"

  # ì˜ì¡´ì„± ë³´ì•ˆ ê²€ì‚¬
  dependency-security:
    name: ğŸ”§ Dependency Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: npm audit ë³´ì•ˆ ê²€ì‚¬
        run: |
          echo "ğŸ” npm audit ë³´ì•ˆ ê²€ì‚¬ ì‹œì‘..."
          npm audit --audit-level high
          echo "âœ… npm audit ë³´ì•ˆ ê²€ì‚¬ ì™„ë£Œ"

      - name: ì˜ì¡´ì„± ì·¨ì•½ì  ìƒì„¸ ê²€ì‚¬
        run: |
          echo "ğŸ” ì˜ì¡´ì„± ì·¨ì•½ì  ìƒì„¸ ê²€ì‚¬..."
          npx audit-ci --config .audit-ci.json || echo "âš ï¸ ì·¨ì•½ì  ë°œê²¬ - ìˆ˜ë™ ê²€í†  í•„ìš”"

  # ì½”ë“œ ë³´ì•ˆ ë¶„ì„
  code-security:
    name: ğŸ” Code Security Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: TypeScript íƒ€ì… ê²€ì‚¬
        run: |
          echo "ğŸ” TypeScript íƒ€ì… ê²€ì‚¬..."
          npx tsc --noEmit
          echo "âœ… TypeScript íƒ€ì… ê²€ì‚¬ ì™„ë£Œ"

      - name: ESLint ë³´ì•ˆ ê·œì¹™ ê²€ì‚¬
        run: |
          echo "ğŸ” ESLint ë³´ì•ˆ ê·œì¹™ ê²€ì‚¬..."
          npm run lint
          echo "âœ… ESLint ë³´ì•ˆ ê·œì¹™ ê²€ì‚¬ ì™„ë£Œ"

      - name: ë³´ì•ˆ ê´€ë ¨ íŒ¨í„´ ê²€ì‚¬
        run: |
          echo "ğŸ” ë³´ì•ˆ ê´€ë ¨ íŒ¨í„´ ê²€ì‚¬..."
          
          # eval() ì‚¬ìš© ê²€ì‚¬
          if grep -r "eval(" --include="*.ts" --include="*.tsx" src/; then
            echo "âš ï¸ eval() ì‚¬ìš©ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ë³´ì•ˆ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤."
          fi
          
          # innerHTML ì‚¬ìš© ê²€ì‚¬
          if grep -r "innerHTML" --include="*.ts" --include="*.tsx" src/; then
            echo "âš ï¸ innerHTML ì‚¬ìš©ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. XSS ì·¨ì•½ì  ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤."
          fi
          
          # console.logì— ë¯¼ê° ì •ë³´ ì¶œë ¥ ê²€ì‚¬
          if grep -r "console\.log.*\(.*password\|.*token\|.*key\|.*secret\)" --include="*.ts" --include="*.tsx" src/; then
            echo "âš ï¸ console.logì— ë¯¼ê°í•œ ì •ë³´ê°€ ì¶œë ¥ë˜ê³  ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
          fi
          
          echo "âœ… ë³´ì•ˆ ê´€ë ¨ íŒ¨í„´ ê²€ì‚¬ ì™„ë£Œ"

  # í™˜ê²½ë³€ìˆ˜ ì„¤ì • ê²€ì¦
  env-validation:
    name: ğŸ”§ Environment Variables Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: í™˜ê²½ë³€ìˆ˜ ê²€ì¦ í…ŒìŠ¤íŠ¸
        env:
          NEXT_PUBLIC_GOOGLE_SCRIPT_URL: ${{ secrets.GOOGLE_SCRIPT_URL }}
          NEXT_PUBLIC_GOOGLE_SHEETS_ID: ${{ secrets.GOOGLE_SHEETS_ID }}
          NEXT_PUBLIC_EMAILJS_SERVICE_ID: ${{ secrets.EMAILJS_SERVICE_ID }}
          NEXT_PUBLIC_EMAILJS_PUBLIC_KEY: ${{ secrets.EMAILJS_PUBLIC_KEY }}
          OPENAI_API_KEY: sk-test-mock-key-for-build-only
        run: |
          echo "ğŸ” í™˜ê²½ë³€ìˆ˜ ê²€ì¦ í…ŒìŠ¤íŠ¸..."
          npm run build
          echo "âœ… í™˜ê²½ë³€ìˆ˜ ê²€ì¦ í…ŒìŠ¤íŠ¸ ì™„ë£Œ"

  # ë³´ì•ˆ ìš”ì•½ ë¦¬í¬íŠ¸
  security-summary:
    name: ğŸ“Š Security Summary
    runs-on: ubuntu-latest
    needs: [secret-detection, dependency-security, code-security, env-validation]
    if: always()
    steps:
      - name: ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼ ìš”ì•½
        run: |
          echo "ğŸ”’ ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼ ìš”ì•½"
          echo "=========================="
          echo "Secret Detection: ${{ needs.secret-detection.result }}"
          echo "Dependency Security: ${{ needs.dependency-security.result }}"
          echo "Code Security: ${{ needs.code-security.result }}"
          echo "Environment Validation: ${{ needs.env-validation.result }}"
          echo "=========================="
          
          if [[ "${{ needs.secret-detection.result }}" == "failure" || 
                "${{ needs.dependency-security.result }}" == "failure" || 
                "${{ needs.code-security.result }}" == "failure" || 
                "${{ needs.env-validation.result }}" == "failure" ]]; then
            echo "âŒ ë³´ì•ˆ ê²€ì‚¬ì—ì„œ ì¤‘ìš”í•œ ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤."
            echo "ğŸ“‹ ìˆ˜ì •ì´ í•„ìš”í•œ í•­ëª©ë“¤ì„ í™•ì¸í•˜ê³  ì¡°ì¹˜í•´ ì£¼ì„¸ìš”."
            exit 1
          else
            echo "âœ… ëª¨ë“  ë³´ì•ˆ ê²€ì‚¬ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤!"
            echo "ğŸ‰ GitHub ê²Œì‹œ ì¤€ë¹„ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
          fi 